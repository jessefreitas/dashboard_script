<script>
(function () {
  if (window.__megaCrmDrawerInit) return;
  window.__megaCrmDrawerInit = true;

  const CFG = {
    TRIGGER_TEXT: 'CRM Negocia√ß√£o',
    TRIGGER_ICON: 'ü§ù',
    PANEL_TITLE: 'Ficha r√°pida de Negocia√ß√£o',
    PANEL_WIDTH: 420,
    STORAGE_KEY: 'mega-crm-negociacao',
    STAGES: ['Prospec√ß√£o', 'Diagn√≥stico', 'Proposta', 'Negocia√ß√£o', 'Fechado ganho', 'Fechado perdido'],
    COLORS: { accent: '#37C978', accentDark: '#2EA664' },
    PLACEMENTS: {
      header: [
        'div.flex.flex-row.gap-3.items-center.justify-between.flex-1.w-full.min-w-0.px-3.py-2',
        'div.flex.flex-row.gap-3.items-center.justify-between.w-full'
      ],
      composer: [
        'form textarea[name="message"] ~ div.flex.items-center.gap-2',
        'footer div.flex.items-center.gap-2'
      ]
    }
  };

  const $ = (s, r = document) => {
    try { return r.querySelector(s); } catch { return null; }
  };

  function ensureStyles() {
    if ($('#mega-crm-style')) return;
    const style = document.createElement('style');
    style.id = 'mega-crm-style';
    style.textContent = `
      #mega-crm-trigger {
        display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border-radius:999px;
        font-weight:600;border:none;cursor:pointer;background:linear-gradient(130deg,${CFG.COLORS.accent},${CFG.COLORS.accentDark});
        color:#052014;box-shadow:0 6px 18px rgba(0,0,0,.25);transition:transform .2s, box-shadow .2s;
      }
      #mega-crm-trigger:hover{transform:translateY(-1px);box-shadow:0 10px 25px rgba(0,0,0,.35);}
      #mega-crm-drawer{position:fixed;inset:0;z-index:9996;pointer-events:none;}
      #mega-crm-drawer::before{content:'';position:absolute;inset:0;background:rgba(0,0,0,.25);opacity:0;transition:opacity .3s;}
      #mega-crm-drawer[data-open="true"]{pointer-events:auto;}
      #mega-crm-drawer[data-open="true"]::before{opacity:1;}
      .mega-crm-panel{position:absolute;top:0;right:0;width:var(--mega-crm-width,${CFG.PANEL_WIDTH}px);height:100%;
        background:var(--mega-crm-bg,#10141C);color:var(--mega-crm-text,#F5F7FA);
        border-left:1px solid var(--mega-crm-border,rgba(255,255,255,.08));box-shadow:-20px 0 35px rgba(0,0,0,.25);
        display:flex;flex-direction:column;transform:translateX(100%);transition:transform .35s;}
      #mega-crm-drawer[data-open="true"] .mega-crm-panel{transform:translateX(0);}
      .mega-crm-panel header{padding:20px 24px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--mega-crm-border,rgba(255,255,255,.08));}
      .mega-crm-panel header h2{margin:0;font-size:18px;}
      .mega-crm-close{font-size:24px;background:none;border:none;cursor:pointer;color:inherit;}
      #mega-crm-form{padding:16px 24px 24px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px;}
      #mega-crm-form label{display:flex;flex-direction:column;gap:6px;font-weight:600;font-size:13px;}
      #mega-crm-form input,#mega-crm-form select,#mega-crm-form textarea{
        border-radius:10px;border:1px solid var(--mega-crm-border,rgba(255,255,255,.08));
        background:var(--mega-crm-input,rgba(255,255,255,.03));padding:10px 12px;font-size:14px;color:inherit;outline:none;
      }
      #mega-crm-form input:focus,#mega-crm-form select:focus,#mega-crm-form textarea:focus{border-color:${CFG.COLORS.accent};}
      #mega-crm-form textarea{min-height:90px;resize:vertical;}
      .mega-crm-actions{padding:16px 24px;border-top:1px solid var(--mega-crm-border,rgba(255,255,255,.08));display:flex;flex-direction:column;gap:8px;}
      .mega-crm-primary,.mega-crm-secondary{border-radius:10px;border:none;cursor:pointer;font-weight:600;padding:12px 18px;font-size:14px;}
      .mega-crm-primary{background:${CFG.COLORS.accent};color:#041311;}
      .mega-crm-primary:hover{background:${CFG.COLORS.accentDark};}
      .mega-crm-secondary{background:transparent;color:inherit;border:1px dashed var(--mega-crm-border,rgba(255,255,255,.25));}
      .mega-crm-status{font-size:12px;opacity:.7;}
    `;
    document.head.appendChild(style);
  }

  function createDrawer() {
    if ($('#mega-crm-drawer')) return;
    const wrapper = document.createElement('div');
    wrapper.id = 'mega-crm-drawer';
    wrapper.innerHTML = `
      <div class="mega-crm-panel" style="--mega-crm-width:${CFG.PANEL_WIDTH}px">
        <header>
          <h2>${CFG.PANEL_TITLE}</h2>
          <button type="button" class="mega-crm-close" aria-label="Fechar">&times;</button>
        </header>
        <form id="mega-crm-form">
          <label>Contato<input name="contato" placeholder="Nome do contato"></label>
          <label>Empresa<input name="empresa" placeholder="Organiza√ß√£o"></label>
          <label>Etapa<select name="etapa">${CFG.STAGES.map(s => `<option value="${s}">${s}</option>`).join('')}</select></label>
          <label>Valor estimado (R$)<input name="valor" type="number" step="0.01" placeholder="0,00"></label>
          <label>Probabilidade (%)<input name="probabilidade" type="number" min="0" max="100" step="5"></label>
          <label>Pr√≥xima a√ß√£o<input name="proxima_acao" type="date"></label>
          <label>Respons√°vel<input name="owner" placeholder="Squad / pessoa"></label>
          <label>Observa√ß√µes<textarea name="notas" placeholder="Contexto, pr√≥ximos passos..."></textarea></label>
        </form>
        <div class="mega-crm-actions">
          <button class="mega-crm-primary" type="button" data-action="save">Salvar rascunho</button>
          <button class="mega-crm-secondary" type="button" data-action="send">Enviar ao CRM / Copiar</button>
          <div class="mega-crm-status" id="mega-crm-status">Nenhuma a√ß√£o ainda.</div>
        </div>
      </div>
    `;
    document.body.appendChild(wrapper);
    wrapper.querySelector('.mega-crm-close').addEventListener('click', () => toggleDrawer(false));
    wrapper.addEventListener('click', ev => { if (ev.target === wrapper) toggleDrawer(false); });
    wrapper.querySelector('[data-action="save"]').addEventListener('click', saveDraft);
    wrapper.querySelector('[data-action="send"]').addEventListener('click', copyPayload);
  }

  function colorsFromTheme() {
    const styles = getComputedStyle(document.body);
    const bg = styles.backgroundColor || '#11151D';
    const text = styles.color || '#F7F8FB';
    const rgb = bg.match(/\d+/g)?.map(Number) || [17,21,29];
    const brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114)/1000;
    const isDark = brightness < 150;
    return {
      panelBg: isDark ? '#10141C' : '#FFFFFF',
      text: isDark ? '#F5F7FA' : '#111827',
      border: isDark ? 'rgba(255,255,255,.08)' : 'rgba(6,6,6,.12)',
      input: isDark ? 'rgba(255,255,255,.03)' : 'rgba(4,17,20,.04)'
    };
  }

  function toggleDrawer(open) {
    const drawer = $('#mega-crm-drawer');
    if (!drawer) return;
    drawer.setAttribute('data-open', open ? 'true' : 'false');
    if (open) {
      const c = colorsFromTheme();
      drawer.style.setProperty('--mega-crm-bg', c.panelBg);
      drawer.style.setProperty('--mega-crm-text', c.text);
      drawer.style.setProperty('--mega-crm-border', c.border);
      drawer.style.setProperty('--mega-crm-input', c.input);
      loadDraft();
    }
  }

  function saveDraft() {
    const data = Object.fromEntries(new FormData($('#mega-crm-form')).entries());
    localStorage.setItem(CFG.STORAGE_KEY, JSON.stringify(data));
    setStatus('Rascunho salvo localmente ‚úîÔ∏è');
  }

  function copyPayload() {
    const data = Object.fromEntries(new FormData($('#mega-crm-form')).entries());
    const text = [
      `Contato: ${data.contato || '-'}`,
      `Empresa: ${data.empresa || '-'}`,
      `Etapa: ${data.etapa || '-'}`,
      `Valor estimado: R$ ${data.valor || '0,00'}`,
      `Probabilidade: ${data.probabilidade || '-'}%`,
      `Pr√≥xima a√ß√£o: ${data.proxima_acao || '-'}`,
      `Respons√°vel: ${data.owner || '-'}`,
      `Observa√ß√µes: ${data.notas || '-'}`
    ].join('\n');
    navigator.clipboard?.writeText(text).then(() => setStatus('Resumo copiado! Cole no CRM ou onde preferir.'))
      .catch(() => setStatus('Copie manualmente:\n' + text));
  }

  function loadDraft() {
    const saved = localStorage.getItem(CFG.STORAGE_KEY);
    if (!saved) return;
    const data = JSON.parse(saved);
    const form = $('#mega-crm-form');
    Object.entries(data).forEach(([k, v]) => {
      const el = form.elements.namedItem(k);
      if (el) el.value = v;
    });
    setStatus('Rascunho carregado automaticamente.');
  }

  function setStatus(msg) { const el = $('#mega-crm-status'); if (el) el.textContent = msg; }

  function findHost() {
    for (const sel of CFG.PLACEMENTS.header) {
      const el = $(sel);
      if (el) return el;
    }
    for (const sel of CFG.PLACEMENTS.composer) {
      const el = $(sel);
      if (el) return el;
    }
    return null;
  }

  function ensureTrigger() {
    let trigger = $('#mega-crm-trigger');
    if (!trigger) {
      trigger = document.createElement('button');
      trigger.id = 'mega-crm-trigger';
      trigger.type = 'button';
      trigger.innerHTML = `<span>${CFG.TRIGGER_ICON}</span><span>${CFG.TRIGGER_TEXT}</span>`;
      trigger.addEventListener('click', () => toggleDrawer(true));
    }
    const host = findHost();
    if (host && !host.contains(trigger)) {
      host.appendChild(trigger);
    }
  }

  function observeLayout() {
    const obs = new MutationObserver(() => ensureTrigger());
    obs.observe(document.body, { childList: true, subtree: true });
    document.addEventListener('keydown', ev => { if (ev.key === 'Escape') toggleDrawer(false); });
  }

  function boot() {
    ensureStyles();
    createDrawer();
    ensureTrigger();
    observeLayout();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>

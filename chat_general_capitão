<script>
(function () {

  /* ================================
     CONFIGURAÇÃO
  ================================= */
  const APP_ID = "omniforge-agente-panel";
  const BTN_ID = "omniforge-agente-btn";

  const IFRAME_URL = "https://webhook.skycracker.com.br/webhook/chat_ativar";
  const BUTTON_TITLE = "Agente Suporte";
  const BUTTON_ICON = "☢︎";

  /* ================================
     CONTEXTO DA CONVERSA
  ================================= */
  function getContextFromURL() {
    const path = window.location.pathname;
    const account = path.match(/accounts\/(\d+)/);
    const conversation = path.match(/conversations\/(\d+)/);

    return {
      account_id: account?.[1] || null,
      conversation_id: conversation?.[1] || null
    };
  }

  /* ================================
     PAINEL LATERAL
  ================================= */
  function ensurePanel() {
    if (document.getElementById(APP_ID)) return;

    const panel = document.createElement("div");
    panel.id = APP_ID;

    Object.assign(panel.style, {
      position: "fixed",
      top: "0",
      right: "0",
      width: "440px",
      height: "100vh",
      background: "var(--color-background, #0B1117)",
      borderLeft: "1px solid #1E293B",
      zIndex: "9999",
      display: "none",
      boxShadow: "-4px 0 12px rgba(0,0,0,.4)",
      fontFamily: "Inter, system-ui, sans-serif",
      color: "#E5E7EB"
    });

    panel.innerHTML = `
      <div style="padding:12px 14px;border-bottom:1px solid #1E293B;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Agente · OmniChat</strong>
          <button id="${APP_ID}-close"
            style="background:none;border:none;font-size:18px;cursor:pointer;color:#94A3B8;">
            ✕
          </button>
        </div>

        <div style="margin-top:6px;font-size:12px;color:#22C55E;">online</div>

        <div style="margin-top:8px;font-size:12px;color:#94A3B8;">
          <strong>Account:</strong> <span id="${APP_ID}-account">—</span>
          &nbsp;•&nbsp;
          <strong>Conversation:</strong> <span id="${APP_ID}-conversation">—</span>
        </div>
      </div>

      <iframe
        id="${APP_ID}-iframe"
        style="width:100%;height:calc(100% - 104px);border:none;"
        src="about:blank">
      </iframe>
    `;

    document.body.appendChild(panel);
    document.getElementById(`${APP_ID}-close`).onclick = closePanel;
  }

  function openPanel() {
    const { account_id, conversation_id } = getContextFromURL();
    if (!account_id || !conversation_id) return;

    document.getElementById(`${APP_ID}-account`).textContent = account_id;
    document.getElementById(`${APP_ID}-conversation`).textContent = conversation_id;

    document.getElementById(`${APP_ID}-iframe`).src =
      `${IFRAME_URL}` +
      `?account_id=${encodeURIComponent(account_id)}` +
      `&conversation_id=${encodeURIComponent(conversation_id)}` +
      `&embed=1`;

    document.getElementById(APP_ID).style.display = "block";
  }

  function closePanel() {
    const panel = document.getElementById(APP_ID);
    if (!panel) return;

    panel.style.display = "none";
    document.getElementById(`${APP_ID}-iframe`).src = "about:blank";
  }

  /* ================================
     BOTÃO NO LEFT-WRAP
  ================================= */
  function injectButton() {
    if (document.getElementById(BTN_ID)) return;

    const leftWrap = document.querySelector("div.left-wrap");
    if (!leftWrap) return;

    const refButton = leftWrap.querySelector("button");
    if (!refButton) return;

    const btn = document.createElement("button");
    btn.id = BTN_ID;
    btn.type = "button";
    btn.title = BUTTON_TITLE;
    btn.className = refButton.className;
    btn.innerHTML = `<span>${BUTTON_ICON}</span>`;
    btn.onclick = openPanel;

    leftWrap.appendChild(btn);
  }

  function sync() {
    ensurePanel();
    injectButton();
  }

  sync();
  new MutationObserver(sync).observe(document.body, {
    childList: true,
    subtree: true
  });

})();
</script>
